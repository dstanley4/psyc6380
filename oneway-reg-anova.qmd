# One-way ANOVA via Regression

## Using Contrasts

```{r}
#| echo: false
knitr::include_graphics("ch_1/image-contrast-use.png")
```

## Treatment/Dummy Coding

Use the Treatment contrast ONLY when you are interested in the contrast itself. DO NOT use if you are interested in typical ANOVA results (main effect, main effect, interaction, etc.).

This approach is the default approach in R unless you specify otherwise. In most cases, this is NOT what you want in Psychology analyses.

Comparisons are to one specific level of the Independent Variables that we call the reference group.

```{r}
#| include: false
library(tidyverse)
library(janitor)
library(pracma)
library(recipes)
library(forcats)
library(apaTables)
library(tidymodels)

viagra <- apaTables::viagra %>% clean_names()

dose = viagra$dose

dose = fct_recode(dose,
                  placebo = "Placebo",
                  low_dose = "Low Dose",
                  high_dose = "High Dose")

viagra$dose = dose

dummies <- recipe(libido ~ dose, data = viagra) %>%
  step_dummy(dose) %>%
  prep() %>%
  bake(viagra)
print(dummies)


readr::write_csv(dummies, file = "viagra_dummy_coded.csv")


options(contrasts = c("contr.treatment", "contr.poly"))
lm_treament =  lm(libido ~ dose + 1, data = viagra)

tidy(lm_treament)
glance(lm_treament)
apaTables::apa.aov.table(lm_treament)



# Constrast sum - relative to grand mean

options(contrasts = c("contr.sum", "contr.poly"))
lm_sum = lm(libido ~ dose + 1, data = viagra)

tidy(lm_sum)
glance(lm_sum)
apa.aov.table(lm_sum)


viagra <- viagra %>% select(libido, dose)

viagra_dummy_coded <- dummies

```

### Original Data

```{r}
print(viagra)
```

Note the means for the three groups are:

```{r}
viagra %>% group_by(dose) %>% summarise(group_mean = mean(libido))
```

### Set Factor with Reference Group

```{r}

viagra <- viagra %>%
  mutate(dose = as_factor(dose)) %>%
  mutate(dose = relevel(dose, ref = "placebo"))
```

### Regression with Treatment Contrast

The computer will always use contrasts when there are categorical variables. So you should set the contrast you want. Here we set the contrast as Treatment (or Dummy) Coding. We use treatment contrasts when we are interested in directly interpreting the regression results.

```{r}

options(contrasts = c("contr.treatment", "contr.poly"))

lm_viagra <- lm(libido ~ dose + 1, data = viagra)
```

```{r}
#| eval: false
tidy(lm_viagra)
```

```{r}
#| echo: false
knitr::kable(tidy(lm_viagra))
```

What is going on here? The single dose column has disappeared. Instead we get $b$-weights for doselow_dose and dosehigh_dose. How do you interpret that information?

### Treatment Contrasts Explained

When we used the treatment contrast we converted the use the rules below:

```{r}
contr.treatment(3)
```

-   The first contrast row (0 0) indicates the mean of group 1 (placebo) is the intercept plus the 0 times first slope and 0 times the second slope.

$$
placebo-mean = 2.20 + 0(1.00) + 0(2.80) = 2.20
$$

-   The second contrast row (1 0) indicates the mean of group 2 (low dose) is the intercept plus the 1 times first slope and 0 times the second slope.

$$
low-dose-mean = 2.20 + 1(1.00) + 0(2.80) = 3.20
$$

-   The third contrast row (0 1) indicates the mean of group 3 (high dose) is the intercept plus the 0 times first slope and 1 times the second slope.

$$
high-dose-mean = 2.20 + 0(1.00) + 1(2.80) = 5.00
$$

Recall the levels of the dose variable:

```{r}
levels(viagra$dose)
```

We set the order of the levels previously with the relevel() command.

When we ran the regression we effectively use the predictors below

```{r}
#| echo: false
viagra_dummy_coded$intercept = rep(1,15)

viagra_dummy_coded <- viagra_dummy_coded %>% select(libido, intercept, dose_low_dose, dose_high_dose )
```

```{r}
print(viagra_dummy_coded)
```

Examine the weights in the above table and see how they can be used to recreate the group means.

```{r}
#| echo: false
ggplot(data = viagra_dummy_coded,
       mapping = aes(x = dose,
                     y = libido)) +
  stat_summary(fun = mean,
               geom="bar") +
  annotate(size = 3, geom = "text", label = "2.2000 +\n (0)(1.00) + (0)(2.80) \n = 2.20", x= 1, y = 2.2000+.6) +
  annotate(size = 3, geom = "text", label = "2.2000 +\n (1)(1.00) + (0)(2.80) \n = 3.20", x= 2, y = 2.2000+1.0000+.6) +
  annotate(size = 3, geom = "text", label = "2.2000 +\n (0)(1.00) + (1)(2.80) \n = 5.00", x= 3, y = 2.2000+2.8000+.6) +
  coord_cartesian(ylim = c(0, 6)) +
  scale_y_continuous(breaks = seq(0, 5, by = .5)) +
  theme_light(12)
```

### ANOVA Summary Information

With a one-way ANOVA, it's easy to extract ANOVA information from the Regression output.

```{r}
#| eval: false
glance(lm_viagra)
```

```{r}
#| echo: false
knitr::kable(glance(lm_viagra))
```

From this output you can see that for this one-way ANOVA, $F$(2, 12) = 5.119, $p$ = .025. In a one-way ANOVA the effect size is $\eta^2 = \eta_{partial}^2=R^2= .46$. Note that in a one-way ANOVA, $\eta^2$ = $\eta_{partial}^2$ but this is not the case when you move to N-way ANOVA.

```{r}
summary(lm_viagra)
```

From this output you can (AGAIN) see that for this one-way ANOVA, $F$(2, 12) = 5.119, $p$ = .025. In a one-way ANOVA the effect size is $\eta^2 = \eta_{partial}^2=R^2= .46$.

Note: A good exam question would be to present a table like this an then ask you the mean for each group. With treatment/dummy coding the regression weight indicate for the reference group the mean of that group. For the other groups, the regression weights indicate the difference from the reference group.

## Sum Contrast / Effect Contrast

We typically use Sum Coding or Effect Coding when we are not interested in the directly interpreting the regression results. Although the results can be directly interpretted this is not commonly done. Instead we use Sum Coding or Effect Coding when we use regression to run an ANOVA. Here we will directly interpret the results, however, to show that it can be done.

With sum coding, the contrasts create $b$-weight represent comparisons of each group mean to the to the grand mean. The contrasts we use for each group are presented below:

```{r}
contr.sum(3)
```

We run the regression with the code below. Notice we take care to set the contrast to sum before the regression.

```{r}

# Check levels
levels(viagra$dose)

# select sum coding
options(contrasts = c("contr.sum", "contr.poly"))

lm_viagra_sum_coded <- lm(libido ~ dose + 1, 
                          data = viagra)

```

We see the results are below. We use as.data.frame() just to see all the decimals.

```{r}
tidy(lm_viagra_sum_coded) %>% as.data.frame()
```

In the results above the intercept corresponds to the grand mean.

Recall the sum contrast below:

```{r}
contr.sum(3)
```

-   The first contrast row (1 0) indicates the mean of group 1 (placebo) is the intercept plus the 1 times first slope and 0 times the second slope.

$$
placebo-mean = 3.4666667 + 1(-1.2666667) + 0(-0.2666667) = 2.20
$$

-   The second contrast row (0 1) indicates the mean of group 2 (low dose) is the intercept plus the 0 times first slope and 1 times the second slope.

$$
low-dose-mean = 3.4666667 + 0(-1.2666667) + 1(-0.2666667)= 3.20
$$

-   The third contrast row (-1 -1) indicates the mean of group 3 (high dose) is the intercept plus -1 times first slope and -1 times the second slope.

$$
high-dose-mean = 3.4666667 + (-1)(-1.2666667) + (-1)(-0.2666667)= 5.00
$$

### Behind the scenes

What is the grand mean? It's just the mean of the dependent variable column across all conditions.

```{r}
summary_stat = viagra %>%
  summarise(grand_mean = mean(libido))

print(summary_stat)

```

```{r}
#| echo: false

viagra_sum_coded <- viagra %>% select(libido)

dose1 <- c(rep(1,5), rep(0,5), rep(-1,5))
dose2 <- c(rep(0,5), rep(1,5), rep(-1,5))

viagra_sum_coded$intercept = rep(1, 15)
viagra_sum_coded$dose1 <- dose1
viagra_sum_coded$dose2 <- dose2

viagra_sum_coded <- viagra_sum_coded %>% select(libido, intercept, dose1, dose2)

readr::write_csv(viagra_sum_coded, file = "viagra_sum_coded.csv")

```

In the above analysis, when we used this code block:

```{r}
#| eval: false
options(contrasts = c("contr.sum", "contr.poly"))

lm_viagra_sum_coded <- lm(libido ~ dose + 1, 
                          data = viagra)
```

We were doing a regression with the predictors below:

```{r}
print(viagra_sum_coded)
```

That is, when we specified this:

```{r}
#| eval: false
lm_viagra <- lm(libido ~ dose + 1, data = viagra)
```

The computer actually ran this:

```{r}
lm_viagra_sum <- lm(libido ~ dose1 + dose2 + 1,
                data = viagra_sum_coded)
```

```{r}
#| eval: false
tidy(lm_viagra_sum)
```

```{r}
#| echo: false
knitr::kable(tidy(lm_viagra_sum))
```

```{r}
#| echo: false
ggplot(data = viagra_sum_coded,
       mapping = aes(x = dose,
                     y = libido)) +
  stat_summary(fun = mean,
               geom="bar") +
  annotate(size = 3,geom = "text", label = "3.4666667 +\n (1)(-1.2666667) + (0)(-0.2666667)   \n= 2.2", x= 1, y = 2.2000+.6) +
  annotate(size = 3,geom = "text", label = "3.4666667 +\n (0)(-1.2666667) + (1)(-0.2666667)   \n= 3.2", x= 2, y = 2.2000+1.0000+.6) +
  annotate(size = 3,geom = "text", label = "3.4666667 +\n (-1)(-1.2666667) + (-1)(-0.2666667) \n= 5", x= 2.95, y = 2.2000+2.8000+.6) +
  coord_cartesian(ylim = c(0, 6)) +
  scale_y_continuous(breaks = seq(0, 6, by = .5)) +
  theme_light(12)
```

### ANOVA values

```{r}
#| eval: false
glance(lm_viagra_sum)
```

```{r}
#| echo: false
knitr::kable(glance(lm_viagra_sum))
```

From this output you can see that for this one-way ANOVA, F(2,12) = 5.118644, p = 0.0246943.

```{r}
summary(lm_viagra_sum)
```

From this output you can (again) see that for this one-way ANOVA, F(2,12) = 5.118644, p = 0.0246943.

## Helmert Contrast

Use the Helmert Contrast if you are interested in typical ANOVA results (main effect, main effect, interaction, etc.).

## Summary: Contrast Types

| Name/Synonym | R command Example | Nature of Comparison | Note |
|------------------|------------------|------------------|------------------|
| Treatment Contrast / Dummy Contrast | ![](contr.treatment.png) | Intercept is the reference group mean. Unstandardized weights indicate difference between a group's mean and reference group mean. In this example, group 1 is the reference group. Notice the first contrast column is for the second group - because group 1 is the intercept. | Default in R. **Do NOT use for ANOVA.** |
| Sum Contrast / Effect Contrast | ![](contr.sum.png) | Intercept is the grand mean. Unstandardized weights are used to create a predicted score that corresponds to the mean for each group. | **USE for ANOVA.** This works because the intercept is the grand mean. |
| Helmert Contrast | ![](contr.helmert.png) | Intercept is the grand mean. First contrast, unstandardized weight indicate difference between Group 2 and Group 1 means. Second contrast, unstandardized weight indicate difference between Group 3 mean and the average of the Group 1 and Group 2 means. Third contrast, unstandardized weight indicate difference between Group 4 mean and the average of the Group 1, Group 2, and Group 3 means. And so on. | **USE for ANOVA.** This works because the intercept is the grand mean. |